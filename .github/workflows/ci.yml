"""
Script de gÃ©nÃ©ration automatique du pipeline DevSecOps
ExÃ©cutez ce script pour crÃ©er tous les fichiers de configuration
"""

import os

def create_directory(path):
    """CrÃ©e un rÃ©pertoire s'il n'existe pas"""
    os.makedirs(path, exist_ok=True)
    print(f"âœ… Dossier crÃ©Ã©/vÃ©rifiÃ©: {path}")

def write_file(path, content):
    """Ã‰crit un fichier avec le contenu donnÃ©"""
    with open(path, 'w', encoding='utf-8') as f:
        f.write(content)
    print(f"âœ… Fichier crÃ©Ã©: {path}")

def setup_devsecops():
    """Configure tous les fichiers DevSecOps"""
    
    print("ðŸš€ Configuration du pipeline DevSecOps...\n")
    
    # 1. CrÃ©er les dossiers
    create_directory('.github/workflows')
    create_directory('Data')
    
    # 2. Workflow GitHub Actions
    workflow_content = """name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  security-analysis:
    name: Security & Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pylint
          pip install pywebview requests
          pip install -r requirements.txt || echo "No requirements.txt"
      
      - name: ðŸ“‹ Create Report Header
        run: |
          echo "# ðŸ”’ DevSecOps Security Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Date** | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \\`${{ github.ref_name }}\\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \\`${GITHUB_SHA::7}\\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Author** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ”’ Bandit Security Scan
        run: |
          echo "## ðŸ”’ Bandit - Security Issues Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          bandit -r . -f txt -o bandit.txt --exclude ./venv,./env,./.venv,./Data || true
          bandit -r . -f json -o bandit.json --exclude ./venv,./env,./.venv,./Data || true
          
          if [ -f bandit.txt ]; then
            echo "<details><summary>ðŸ“„ Click to view Bandit report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```
            cat bandit.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No security issues found**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: ðŸ›¡ï¸ Safety Dependency Check
        run: |
          echo "## ðŸ›¡ï¸ Safety - Dependency Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          safety check -o text > safety.txt || true
          safety check --json > safety.json || true
          
          if [ -f safety.txt ]; then
            echo "<details><summary>ðŸ“„ Click to view Safety report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```
            cat safety.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No vulnerable dependencies**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: âœ… Pylint Code Quality Analysis
        run: |
          echo "## âœ… Pylint - Code Quality Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./env/*" -not -path "./Data/*" > files.txt
          echo "### Files Analyzed:" >> $GITHUB_STEP_SUMMARY
          cat files.txt | while read file; do
            echo "- \\`$file\\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          
          pylint --output-format=text --exit-zero $(cat files.txt) > pylint.txt || true
          pylint --output-format=json --exit-zero $(cat files.txt) > pylint.json || true
          
          echo "<details><summary>ðŸ“„ Click to view Pylint report</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```
          head -n 150 pylint.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: ðŸ“Š Generate Statistics
        run: |
          echo "## ðŸ“Š Project Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          PY_FILES=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./env/*" | wc -l)
          echo "| Python Files | $PY_FILES |" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_LINES=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./env/*" -exec cat {} \\; | wc -l)
          echo "| Total Lines | $TOTAL_LINES |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f bandit.json ]; then
            BANDIT_ISSUES=$(grep -o '"issue_text"' bandit.json | wc -l)
            echo "| Bandit Issues | $BANDIT_ISSUES |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: ðŸ“¤ Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: devsecops-reports-${{ github.run_number }}
          path: |
            bandit.txt
            bandit.json
            safety.txt
            safety.json
            pylint.txt
            pylint.json
          retention-days: 30
      
      - name: âš ï¸ Final Check
        run: |
          echo "## âš ï¸ Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build completed** - Review reports above" >> $GITHUB_STEP_SUMMARY
        continue-on-error: false
"""
    write_file('.github/workflows/ci.yml', workflow_content)
    
    # 3. Requirements.txt
    requirements_content = """pywebview>=4.4.0
requests>=2.31.0
"""
    write_file('requirements.txt', requirements_content)
    
    # 4. Configuration Bandit
    bandit_content = """exclude_dirs:
  - /venv
  - /.venv
  - /env
  - /Data
  - /tests

skips:
  - B101
"""
    write_file('.bandit', bandit_content)
    
    # 5. Configuration Pylint
    pylintrc_content = """[MASTER]
ignore=venv,.venv,env,Data,migrations,__pycache__
jobs=4

[MESSAGES CONTROL]
disable=
    C0111,
    C0103,
    C0301,
    R0903,
    R0913,
    W0212,
    W0613,
    W0703

[FORMAT]
max-line-length=120
max-module-lines=1000
indent-string='    '

[DESIGN]
max-args=8
max-locals=20
max-branches=15
max-statements=60
max-returns=8
max-attributes=10

[BASIC]
good-names=i,j,k,ex,Run,_,id,pk,f,e
variable-rgx=[a-z_][a-z0-9_]{1,30}$
const-rgx=(([A-Z_][A-Z0-9_]*)|(__.*__))$
"""
    write_file('.pylintrc', pylintrc_content)
    
    # 6. GitIgnore
    gitignore_content = """# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
.venv/
ENV/
build/
dist/
*.egg-info/

# IDE
.vscode/
.idea/
*.swp
*.swo

# Reports
bandit.txt
bandit.json
safety.txt
safety.json
pylint.txt
pylint.json
files.txt

# Data
Data/*.csv
!Data/.gitkeep
"""
    write_file('.gitignore', gitignore_content)
    
    # 7. README
    readme_content = """# ðŸ”’ Projet DevSecOps Python

Application de gestion de commandes avec authentification sÃ©curisÃ©e.

## ðŸ“‹ Description

Ce projet intÃ¨gre un pipeline DevSecOps automatisÃ© avec :
- **Bandit** : DÃ©tection de vulnÃ©rabilitÃ©s de sÃ©curitÃ©
- **Safety** : VÃ©rification des dÃ©pendances vulnÃ©rables  
- **Pylint** : Analyse de qualitÃ© du code

## ðŸ“¦ Installation

